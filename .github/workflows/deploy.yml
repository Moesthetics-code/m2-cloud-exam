# .github/workflows/deploy.yml
name: AWS Cloud Deployment

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

env:
    AWS_REGION: eu-north-1
    BUCKET_NAME: m2-cloud-logs-mouhamed
    LAMBDA_FUNCTION: stop-ec2-function

jobs:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #  STAGE 1 : VALIDATE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    validate:
        name: ğŸ” Validate AWS Credentials
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Verify Identity
              run: |
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸ” AWS Caller Identity"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  aws sts get-caller-identity
                  echo "âœ… Credentials valides"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #  STAGE 2 : DEPLOY LAMBDA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    deploy_lambda:
        name: ğŸš€ Deploy Lambda
        runs-on: ubuntu-latest
        needs: validate

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Package Lambda
              run: |
                  echo "ğŸ“¦ Packaging Lambda function..."
                  cd lambda
                  zip -r ../function.zip lambda_function.py
                  cd ..
                  ls -lh function.zip

            - name: Update Lambda Code
              run: |
                  echo "ğŸš€ Deploying to Lambda: $LAMBDA_FUNCTION"
                  aws lambda update-function-code \
                    --function-name $LAMBDA_FUNCTION \
                    --zip-file fileb://function.zip \
                    --region $AWS_REGION

                  echo "âœ… Lambda updated successfully"

            - name: Verify Deployment
              run: |
                  echo "ğŸ” Verifying Lambda deployment..."
                  aws lambda get-function \
                    --function-name $LAMBDA_FUNCTION \
                    --region $AWS_REGION \
                    --query 'Configuration.[FunctionName,Runtime,LastModified]' \
                    --output table

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #  STAGE 3 : UPLOAD SCRIPT TO S3
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    upload_script:
        name: ğŸ“¤ Upload Script to S3
        runs-on: ubuntu-latest
        needs: validate

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Upload to S3
              run: |
                  echo "ğŸ“¤ Uploading script to S3..."
                  aws s3 cp scripts/upload-to-s3.sh \
                    s3://$BUCKET_NAME/scripts/upload-to-s3.sh \
                    --region $AWS_REGION

                  echo "âœ… Script uploaded successfully"
                  echo "ğŸ“ s3://$BUCKET_NAME/scripts/upload-to-s3.sh"

            - name: Verify Upload
              run: |
                  echo "ğŸ” Verifying S3 upload..."
                  aws s3 ls s3://$BUCKET_NAME/scripts/ --region $AWS_REGION

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #  DEPLOYMENT SUMMARY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    summary:
        name: ğŸ“Š Deployment Summary
        runs-on: ubuntu-latest
        needs: [deploy_lambda, upload_script]

        steps:
            - name: Summary
              run: |
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "âœ… DEPLOYMENT SUCCESSFUL"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo "ğŸš€ Lambda: $LAMBDA_FUNCTION"
                  echo "ğŸ“¦ Bucket: $BUCKET_NAME"
                  echo "ğŸŒ Region: $AWS_REGION"
                  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
